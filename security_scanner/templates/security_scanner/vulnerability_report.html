{% extends 'security_scanner/base.html' %}

{% block title %}Security Measures{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Security Measures Report</h2>
        
        <div class="card">
            <div class="card-body text-center py-5">
                <button id="run-tests-btn" class="btn scan-btn" onclick="runSecurityTests()">
                    <i class="bi bi-play-circle"></i> Run Security Analysis
                </button>
                <p class="mt-3 mb-0 text-muted">Click to analyze implemented security measures</p>
            </div>
        </div>
        
        <div class="row" id="vuln-stats" style="display: none;">
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Critical</h5>
                        <div class="summary-number text-danger" id="critical-vulns">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">High</h5>
                        <div class="summary-number text-warning" id="high-vulns">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Medium</h5>
                        <div class="summary-number text-info" id="medium-vulns">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Low</h5>
                        <div class="summary-number text-success" id="low-vulns">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4" id="vulnerability-results" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">Implemented Security Measures</h5>
            </div>
            <div class="card-body">
                <div id="vulnerability-content"></div>
            </div>
        </div>
    </div>
</div>

<script>
function runSecurityTests() {
    // Show loading overlay
    const loadingOverlay = document.getElementById('loading-overlay');
    const scanProgress = document.getElementById('scan-progress');
    const scanStatus = document.getElementById('scan-status');
    
    loadingOverlay.style.display = 'flex';
    scanProgress.style.width = '0%';
    scanStatus.textContent = 'Initializing security analysis...';
    
 
    let progress = 0;
    const progressMessages = [
        'Initializing security framework...',
        'Loading vulnerability database...',
        'Scanning for XSS vulnerabilities...',
        'Checking SQL injection protection...',
        'Analyzing authentication mechanisms...',
        'Reviewing authorization controls...',
        'Inspecting session management...',
        'Validating input sanitization...',
        'Checking for insecure dependencies...',
        'Analyzing network security...',
        'Performing penetration testing simulation...',
        'Generating vulnerability report...'
    ];
    
    let messageIndex = 0;
    
    const progressInterval = setInterval(() => {
        progress += 1;
        if (progress <= 100) {
            scanProgress.style.width = progress + '%';
            // Update message at specific progress points
            if (messageIndex < progressMessages.length && progress >= (messageIndex + 1) * 8) {
                scanStatus.textContent = progressMessages[messageIndex];
                messageIndex++;
            } else {
                scanStatus.textContent = `Analyzing security measures... (${progress}%)`;
            }
        }
        
        // When progress reaches 100%, stop the interval and make the API call
        if (progress >= 100) {
            clearInterval(progressInterval);
            scanStatus.textContent = 'Finalizing results...';
            
            // Make AJAX request to run tests
            setTimeout(() => {
                fetch('{% url "security_scanner:run_tests" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Update vulnerability stats
                    document.getElementById('critical-vulns').textContent = data.stats.critical;
                    document.getElementById('high-vulns').textContent = data.stats.high;
                    document.getElementById('medium-vulns').textContent = data.stats.medium;
                    document.getElementById('low-vulns').textContent = data.stats.low;
                    
                    // Show stats
                    const totalVulns = data.stats.critical + data.stats.high + data.stats.medium + data.stats.low;
                    document.getElementById('vuln-stats').style.display = 'flex';
                    
                    displaySecurityMeasures(data.results);
                    
                    // Hide loading overlay
                    loadingOverlay.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('vulnerability-content').innerHTML = 
                        '<div class="alert alert-danger">Error running tests: ' + error.message + '</div>';
                    
                    // Hide loading overlay
                    loadingOverlay.style.display = 'none';
                });
            }, 500);
        }
    }, 150);
}

function displaySecurityMeasures(results) {
    // Show the results card
    document.getElementById('vulnerability-results').style.display = 'block';
    
    // Create security measures list
    let html = '<div class="row">';
    
    // Show passed measures first
    const passedMeasures = results.filter(result => result.status === 'PASS');
    if (passedMeasures.length > 0) {
        html += `
        <div class="col-12 mb-4">
            <div class="alert alert-success">
                <h5><i class="bi bi-shield-check me-2"></i>Successfully Implemented Security Measures</h5>
                <p class="mb-0">The following security measures have been properly implemented:</p>
            </div>
        </div>
        `;
        
        passedMeasures.forEach(result => {
            html += `
            <div class="col-md-12">
                <div class="card test-result-card pass">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="card-title mb-0">${result.test}</h6>
                            <span class="status-badge status-pass">PASS</span>
                        </div>
                        <p class="card-text mt-2 mb-0"><small>${result.details}</small></p>
                    </div>
                </div>
            </div>
            `;
        });
    }
    
    // Show info measures
    const infoMeasures = results.filter(result => result.status === 'INFO');
    if (infoMeasures.length > 0) {
        html += `
        <div class="col-12 mb-4 mt-4">
            <div class="alert alert-info">
                <h5><i class="bi bi-info-circle me-2"></i>Informational Security Notes</h5>
                <p class="mb-0">The following are informational notes about security configuration:</p>
            </div>
        </div>
        `;
        
        infoMeasures.forEach(result => {
            html += `
            <div class="col-md-12">
                <div class="card test-result-card info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="card-title mb-0">${result.test}</h6>
                            <span class="status-badge status-info">INFO</span>
                        </div>
                        <p class="card-text mt-2 mb-0"><small>${result.details}</small></p>
                    </div>
                </div>
            </div>
            `;
        });
    }
    
    // Show any actual vulnerabilities
    const vulnerabilities = results.filter(result => result.status === 'FAIL' || result.status === 'WARNING');
    if (vulnerabilities.length > 0) {
        html += `
        <div class="col-12 mb-4 mt-4">
            <div class="alert alert-warning">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>Security Issues Requiring Attention</h5>
                <p class="mb-0">The following security issues should be reviewed:</p>
            </div>
        </div>
        `;
        
        vulnerabilities.forEach(result => {
            let statusClass = result.risk;
            let statusBadgeClass = 'status-' + result.risk;
            
            html += `
            <div class="col-md-12">
                <div class="card test-result-card ${statusClass}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="card-title mb-0">${result.test}</h6>
                            <span class="status-badge ${statusBadgeClass}">${result.status}</span>
                        </div>
                        <p class="card-text mt-2 mb-0"><small>${result.details}</small></p>
                    </div>
                </div>
            </div>
            `;
        });
    } else if (passedMeasures.length > 0 || infoMeasures.length > 0) {
        html += `
        <div class="col-12 mt-4">
            <div class="alert alert-success">
                <h5><i class="bi bi-check-circle-fill me-2"></i>Security Assessment Complete</h5>
                <p class="mb-0">All implemented security measures are functioning properly. No critical or high-risk vulnerabilities detected.</p>
            </div>
        </div>
        `;
    }
    
    html += '</div>';
    
    document.getElementById('vulnerability-content').innerHTML = html;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}